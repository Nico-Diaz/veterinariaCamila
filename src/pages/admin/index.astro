---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Admin Seguro | Veterinaria Camila">
    <div class="app-wrapper">
        
        <div id="login-screen" class="login-overlay">
            <div class="login-card">
                <div class="login-icon">üîê</div>
                <h2>Acceso Seguro</h2>
                <p>Solo personal autorizado</p>
                
                <form id="login-form">
                    <input type="email" id="email" placeholder="admin@veterinaria.com" required />
                    <input type="password" id="password" placeholder="Contrase√±a..." required />
                    <button type="submit" id="btn-login">Iniciar Sesi√≥n</button>
                </form>

                <p id="login-error" class="error-msg">Credenciales incorrectas</p>
            </div>
        </div>

        <div id="admin-screen" style="display: none;">
            
            <nav class="navbar">
                <div class="brand"><span>üêæ</span> Vet. <strong>Camila</strong></div>
                <button id="btn-logout" class="btn-logout">Cerrar Sesi√≥n</button>
            </nav>

            <main class="container">
                <div class="header-row">
                    <div class="titles">
                        <h1>Panel de Control</h1>
                        <p id="user-display">Usuario: ...</p>
                    </div>
                    <button id="btn-refresh" class="btn-refresh">üîÑ</button>
                </div>

                <div class="stats-container">
                    <div class="stat-card">
                        <span class="label">Total</span>
                        <strong id="stat-total">-</strong>
                    </div>
                    <div class="stat-card highlight">
                        <span class="label">Pendientes</span>
                        <strong id="stat-pending">-</strong>
                    </div>
                </div>

                <div class="list-container">
                    <table class="responsive-table">
                        <thead class="table-head">
                            <tr>
                                <th>Fecha</th>
                                <th>Paciente</th>
                                <th>Contacto</th>
                                <th>Estado</th>
                                <th class="text-right">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-turnos">
                            </tbody>
                    </table>
                    
                    <div id="empty-state" class="empty-state" style="display: none;">
                        <div class="empty-icon">üîí</div>
                        <h3>Sin acceso o sin datos</h3>
                        <p>Inicia sesi√≥n para ver los turnos.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>
</Layout>

<script>
    import { supabase } from '../../lib/supabase';

    // 1. REFERENCIAS AL DOM (Agregamos '!' y 'as ...' para calmar a TypeScript)
    const loginScreen = document.getElementById('login-screen')!;
    const adminScreen = document.getElementById('admin-screen')!;
    const loginForm = document.getElementById('login-form') as HTMLFormElement; // 'as' define el tipo
    const errorMsg = document.getElementById('login-error')!;
    const btnLogout = document.getElementById('btn-logout')!;
    const btnRefresh = document.getElementById('btn-refresh'); // Este puede ser null si no carg√≥ a√∫n
    
    // --- CHEQUEO DE SESI√ìN ---
    checkSession();

    async function checkSession() {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
            showDashboard(session.user.email);
        } else {
            // Como usamos '!', ya no marca error aqu√≠
            loginScreen.style.display = 'flex';
        }
    }

    // --- LOGICA DE LOGIN ---
    if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Casting seguro para inputs
            const emailInput = document.getElementById('email') as HTMLInputElement;
            const passInput = document.getElementById('password') as HTMLInputElement;
            const btnLogin = document.getElementById('btn-login') as HTMLButtonElement;

            const email = emailInput.value;
            const password = passInput.value;

            btnLogin.innerText = "Verificando...";
            errorMsg.style.display = 'none';

            const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password
            });

            if (error) {
                btnLogin.innerText = "Iniciar Sesi√≥n";
                errorMsg.innerText = "Error: " + error.message;
                errorMsg.style.display = 'block';
            } else {
                showDashboard(data.user.email);
            }
        });
    }

    // --- LOGICA DE LOGOUT ---
    if (btnLogout) {
        btnLogout.addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.reload();
        });
    }

    // --- MOSTRAR PANEL ---
    function showDashboard(email: string | undefined) {
        if(loginScreen) loginScreen.style.display = 'none';
        if(adminScreen) adminScreen.style.display = 'block';
        
        const userDisplay = document.getElementById('user-display');
        if(userDisplay && email) userDisplay.innerText = `Admin: ${email}`;
        
        loadData();
    }

    // --- CARGAR DATOS ---
    if (btnRefresh) {
        btnRefresh.addEventListener('click', () => {
            btnRefresh.classList.add('spin');
            loadData().then(() => setTimeout(() => btnRefresh.classList.remove('spin'), 500));
        });
    }

    async function loadData() {
        const tbody = document.getElementById('tbody-turnos');
        const emptyState = document.getElementById('empty-state');
        const lastUpdate = document.getElementById('last-update');
        const statTotal = document.getElementById('stat-total');
        const statPending = document.getElementById('stat-pending');

        // Si no encuentra la tabla, cortamos para evitar errores
        if (!tbody || !emptyState) return;
        
        tbody.innerHTML = ''; 

        const { data: turnos, error } = await supabase
            .from('turnos')
            .select('*')
            .order('id', { ascending: false });

        if (error) {
            console.error(error);
            alert("Sesi√≥n expirada o error de red.");
            return;
        }

        // Actualizar hora y stats (con chequeo por si acaso)
        const now = new Date();
        const timeString = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
        if(lastUpdate) lastUpdate.innerText = `Actualizado: ${timeString}`;

        const total = turnos?.length || 0;
        const pendientes = turnos?.filter(t => t.estado === 'Pendiente').length || 0;
        
        if(statTotal) statTotal.innerText = total.toString();
        if(statPending) statPending.innerText = pendientes.toString();

        if (!turnos || turnos.length === 0) {
            tbody.style.display = 'none';
            emptyState.style.display = 'flex';
            return;
        }
        
        tbody.style.display = ''; 
        emptyState.style.display = 'none';

        turnos.forEach(t => {
            const tr = document.createElement('tr');
            tr.className = "data-row";
            
            const cleanPhone = t.telefono.replace(/[^0-9]/g, '');
            const waLink = `https://wa.me/${cleanPhone}`;
            const initial = t.mascota.charAt(0).toUpperCase();
            const dateObj = new Date(t.fecha + 'T00:00:00');
            const day = dateObj.toLocaleDateString('es-AR', { day: 'numeric', month: 'short' });

            tr.innerHTML = `
                <td class="col-date">
                    <div class="date-content">
                        <span class="d-day">${day}</span>
                        <span class="d-time">${t.hora}</span>
                    </div>
                    <span class="pill mobile-pill ${t.estado.toLowerCase()}">${t.estado}</span>
                </td>
                
                <td class="col-patient">
                    <div class="patient-wrap">
                        <div class="avatar">${initial}</div>
                        <div class="p-info">
                            <span class="p-name">${t.mascota}</span>
                            <span class="p-srv">${t.servicio || 'Castraci√≥n'}</span>
                        </div>
                    </div>
                </td>

                <td class="col-owner">
                    <div class="owner-wrap">
                        <div class="owner-text">
                            <span class="mobile-label">Due√±o:</span>
                            <span class="o-name">${t.nombre}</span>
                        </div>
                        <a href="${waLink}" target="_blank" class="wa-btn">WhatsApp</a>
                    </div>
                </td>

                <td class="col-status desktop-pill">
                    <span class="pill ${t.estado.toLowerCase()}">${t.estado}</span>
                </td>

                <td class="col-actions">
                    <button class="btn-delete delete" data-id="${t.id}">
                        üóëÔ∏è <span class="mobile-text">Eliminar</span>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.querySelectorAll('.delete').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                if(confirm('¬øBorrar turno?')) {
                    const id = (e.currentTarget as HTMLElement).getAttribute('data-id');
                    await supabase.from('turnos').delete().eq('id', id);
                    loadData();
                }
            });
        });
    }
</script>

<style is:global>
    /* === ESTILOS RESPONSIVOS (Manteniendo el dise√±o bonito anterior) === */
    :root { --primary: #7C2D96; --bg: #F3F4F6; --green: #25D366; }
    body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; color: #333; padding-bottom: 50px; }
    
    /* Login Ajustado */
    .login-overlay { position: fixed; inset: 0; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 100; }
    .login-card { background: white; padding: 40px; border-radius: 15px; text-align: center; width: 90%; max-width: 350px; }
    .login-card input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    .login-card button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    .error-msg { color: #ef4444; margin-top: 10px; font-size: 0.9rem; display: none; }

    /* Navbar */
    .navbar { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 50; }
    .brand { font-weight: 700; font-size: 1.1rem; }
    .brand strong { color: var(--primary); }
    .btn-logout { border: 1px solid #ddd; background: white; padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }

    .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
    .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .btn-refresh { background: white; border: none; font-size: 1.5rem; cursor: pointer; transition: transform 0.5s; }
    .spin { transform: rotate(360deg); }

    .stats-container { display: flex; gap: 10px; margin-bottom: 20px; }
    .stat-card { flex: 1; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .stat-card.highlight { border-bottom: 4px solid var(--primary); }
    .stat-card strong { font-size: 1.5rem; display: block; }

    /* === RESPONSIVE TABLE === */
    .responsive-table { width: 100%; border-collapse: separate; border-spacing: 0; }
    .pill { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; }
    .pendiente { background: #FFF3CD; color: #856404; }
    .confirmado { background: #D1FAE5; color: #065F46; }

    /* M√ìVIL */
    @media (max-width: 768px) {
        .table-head, .desktop-pill { display: none; }
        .list-container { background: transparent; }
        .responsive-table, tbody, tr, td { display: block; width: 100%; box-sizing: border-box; }
        
        tr.data-row {
            background: white; margin-bottom: 20px; border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #fff;
        }

        .col-date { background: #F8F9FA; padding: 12px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .date-content { display: flex; align-items: center; gap: 8px; font-weight: 700; color: #555; text-transform: uppercase; }
        .mobile-pill { display: inline-block; }

        .col-patient { padding: 20px 20px 5px 20px; }
        .patient-wrap { display: flex; align-items: center; gap: 15px; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; background: #E0C3FC; color: #4A148C; font-size: 1.2rem; display: flex; justify-content: center; align-items: center; font-weight: 700; }
        .p-name { font-size: 1.2rem; font-weight: 700; display: block; }
        .p-srv { color: #888; font-size: 0.9rem; }

        .col-owner { padding: 10px 20px 15px 20px; }
        .owner-wrap { display: flex; flex-direction: column; gap: 10px; }
        .owner-text { display: flex; gap: 5px; align-items: baseline; }
        .mobile-label { font-size: 0.85rem; color: #888; }
        .o-name { font-weight: 600; font-size: 1rem; }
        .wa-btn { background: var(--green); color: white; padding: 12px; border-radius: 10px; text-decoration: none; font-weight: 700; text-align: center; display: block; width: 100%; }

        .col-actions { padding: 0 20px 20px 20px; border-top: 1px solid #fafafa; padding-top: 15px; }
        .btn-delete { width: 100%; background: white; border: 2px solid #ffecec; color: #ef4444; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; justify-content: center; gap: 8px; }
    }

    /* PC */
    @media (min-width: 769px) {
        .list-container { background: white; border-radius: 16px; padding: 5px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .table-head { display: table-header-group; }
        .mobile-pill, .mobile-label, .mobile-text { display: none; }
        .responsive-table { display: table; width: 100%; }
        tbody { display: table-row-group; }
        tr.data-row { display: table-row; background: transparent; box-shadow: none; border-radius: 0; }
        tr.data-row:hover { background-color: #f9fafb; }
        td { display: table-cell; padding: 15px 20px; vertical-align: middle; border-bottom: 1px solid #f0f0f0; }
        th { text-align: left; padding: 15px 20px; background: #fafafa; color: #888; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; }

        .date-content { flex-direction: column; align-items: flex-start; gap: 0; text-transform: none; }
        .d-day { font-size: 0.95rem; font-weight: 700; color: #333; }
        .d-time { font-size: 0.8rem; color: #888; font-weight: 400; }
        .patient-wrap { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 40px; height: 40px; font-size: 0.9rem; }
        .owner-wrap { flex-direction: row; align-items: center; gap: 10px; }
        .wa-btn { background: #D1FAE5; color: #065F46; padding: 4px 12px; border-radius: 20px; text-decoration: none; font-size: 0.75rem; font-weight: 700; width: auto; }
        .btn-delete { background: white; border: 1px solid #eee; width: 35px; height: 35px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .text-right { text-align: right; }
    }

    .empty-state { padding: 50px; text-align: center; display: flex; flex-direction: column; align-items: center; }
    .empty-icon { font-size: 3rem; opacity: 0.5; }
</style>